---
title: MCP Server
sidebar_position: 8
---

# MCP Server

The programmatic tools generated by Agent Codemode (from [MCP Servers](../mcp-tools/index.mdx) and [Skills](../skills/index.mdx)) can be **exposed as an MCP Server** for any MCP-compatible client.

This allows you to:
- Use Agent Codemode's code-first tool composition from any MCP client
- Build meta-agents that discover and compose tools programmatically
- Create a unified interface to multiple MCP servers through code execution

## Quick Start

### Run as Command

Start the Codemode MCP server:

```bash
python -m agent_codemode.server
```

### Run Programmatically

```python
from agent_codemode import codemode_server, configure_server
from agent_codemode import ToolRegistry, MCPServerConfig, CodeModeConfig

# Create and configure registry with MCP servers to compose
registry = ToolRegistry()
registry.add_server(MCPServerConfig(
    name="filesystem",
    command="npx",
    args=["-y", "@anthropic/mcp-server-filesystem", "/workspace"]
))
registry.add_server(MCPServerConfig(
    name="github",
    command="npx",
    args=["-y", "@anthropic/mcp-server-github"],
    env={"GITHUB_TOKEN": "your-token"}
))

# Configure the server
config = CodeModeConfig(
    workspace_path="/workspace",
    skills_path="./skills",
    generated_path="./generated",
)

configure_server(config=config, registry=registry)

# Run with stdio transport (default)
from agent_codemode.server import run
run()

# Or run with SSE transport on a specific port
run(transport="sse", port=8000)
```

## Server Configuration

### Environment Variables

```bash
export CODEMODE_WORKSPACE="/workspace"
export CODEMODE_GENERATED="/tmp/generated"
export CODEMODE_SKILLS="./skills"
export CODEMODE_TIMEOUT="60"
export CODEMODE_SANDBOX="local"

python -m agent_codemode.server
```

### Command Line Options

```bash
python -m agent_codemode.server --transport stdio  # Default: stdio transport
python -m agent_codemode.server --transport sse --port 8000  # SSE transport
```

You can also set environment variables:

```bash
export CODEMODE_WORKSPACE="/workspace"
export CODEMODE_GENERATED="/tmp/generated"
export CODEMODE_SKILLS="./skills"
export CODEMODE_TIMEOUT="60"
export CODEMODE_SANDBOX="local"

python -m agent_codemode.server
```

### Programmatic Configuration

```python
from agent_codemode import CodeModeConfig

config = CodeModeConfig(
    workspace_path="/workspace",           # Working directory
    generated_path="/tmp/generated",       # Generated bindings location
    skills_path="./skills",                # Skills directory
    default_timeout=60.0,                  # Execution timeout
    sandbox_variant="local",               # Sandbox type
    allow_direct_tool_calls=False,         # Hide call_tool (force code mode)
    max_tool_calls=100,                    # Safety cap per execution
)
```

## Exposed Tools

The Codemode MCP Server exposes the following tools:

### Tool Discovery

| Tool | Description |
|------|-------------|
| `search_tools` | Progressive tool discovery with natural language queries |
| `list_servers` | List all connected MCP servers |
| `get_tool_details` | Get full schema for a specific tool |

### Code Execution

| Tool | Description |
|------|-------------|
| `execute_code` | Execute Python code that composes tools |
| `call_tool` | Direct tool invocation (when `allow_direct_tool_calls=True`) |

### Skills Management

| Tool | Description |
|------|-------------|
| `list_skills` | List available saved skills |
| `save_skill` | Save a new skill |
| `run_skill` | Execute a saved skill |
| `delete_skill` | Remove a skill |

### Server Management

| Tool | Description |
|------|-------------|
| `add_mcp_server` | Dynamically add new MCP servers |
| `get_execution_history` | View recent execution history |

## Tool Details

### search_tools

Search for available tools from all connected MCP servers:

```python
result = await client.call_tool("search_tools", {
    "query": "file operations",
    "limit": 10,
    "include_deferred": True
})
# Returns: {"tools": [...], "total": 15, "has_more": True}
```

### execute_code

Execute Python code that composes MCP tools:

```python
result = await client.call_tool("execute_code", {
    "code": """
import asyncio
from generated.servers.filesystem import read_file, write_file

# Read multiple files in parallel
files = ["/data/a.txt", "/data/b.txt", "/data/c.txt"]
contents = await asyncio.gather(*[read_file({"path": f}) for f in files])

# Process and write results
for i, content in enumerate(contents):
    await write_file({
        "path": f"/output/processed_{i}.txt",
        "content": content.upper()
    })

print(f"Processed {len(files)} files")
""",
    "timeout": 30.0
})
# Returns: {"success": True, "result": "...", "stdout": "Processed 3 files", ...}
```

### save_skill

Save a reusable skill:

```python
result = await client.call_tool("save_skill", {
    "name": "batch_uppercase",
    "description": "Convert all files in a directory to uppercase",
    "code": '''
async def batch_uppercase(input_dir, output_dir):
    from generated.servers.filesystem import list_directory, read_file, write_file
    
    entries = await list_directory({"path": input_dir})
    for entry in entries["entries"]:
        content = await read_file({"path": f"{input_dir}/{entry}"})
        await write_file({"path": f"{output_dir}/{entry}", "content": content.upper()})
    return {"processed": len(entries["entries"])}
''',
    "tags": ["file", "batch", "text"]
})
```

### run_skill

Execute a saved skill:

```python
result = await client.call_tool("run_skill", {
    "name": "batch_uppercase",
    "arguments": {
        "input_dir": "/data/input",
        "output_dir": "/data/output"
    }
})
```

## Connecting Clients

### Python MCP Client

```python
from mcp import Client

client = Client()
await client.connect("stdio://python -m agent_codemode.server")

# Search for tools
tools = await client.call_tool("search_tools", {"query": "read files"})

# Execute code
result = await client.call_tool("execute_code", {
    "code": """
from generated.servers.filesystem import read_file
content = await read_file({"path": "/data/config.json"})
print(content)
"""
})
```

### Claude Desktop Configuration

Add to your Claude Desktop config:

```json
{
  "mcpServers": {
    "codemode": {
      "command": "python",
      "args": ["-m", "agent_codemode.server"],
      "env": {
        "CODEMODE_WORKSPACE": "/workspace"
      }
    }
  }
}
```

### From Another MCP Server

You can chain MCP servers - have one MCP server use Codemode as a client:

```python
from mcp import Client

# In your MCP server, connect to Codemode
codemode = Client()
await codemode.connect("stdio://python -m agent_codemode.server")

# Use Codemode's code execution from your server
result = await codemode.call_tool("execute_code", {"code": "..."})
```

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MCP Client                                  â”‚
â”‚              (Claude, custom agent, another MCP server)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ MCP Protocol
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Codemode MCP Server                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ search_tools â”‚  â”‚execute_code â”‚  â”‚ save_skill / run_skill     â”‚  â”‚
â”‚  â”‚ list_servers â”‚  â”‚  call_tool  â”‚  â”‚ list_skills / delete_skill â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        Tool Registry                                â”‚
â”‚            (discovers tools from connected MCP servers)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     Code Executor (Sandbox)                         â”‚
â”‚         (runs Python code with generated tool bindings)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ MCP Protocol
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Connected MCP Servers                          â”‚
â”‚    filesystem, github, slack, database, web, custom servers...      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Use Cases

### 1. Meta-Agent for Tool Composition

Build an agent that uses Codemode to intelligently compose tools:

```
User: "Analyze all Python files in /project and create a summary report"

Agent: 
1. Calls search_tools("python file analysis") 
2. Discovers filesystem and analysis tools
3. Writes code that reads files, analyzes them, generates report
4. Calls execute_code with the generated code
```

### 2. Unified Interface to Multiple Services

Combine multiple MCP servers into one code-first interface:

```python
# Connect multiple specialized MCP servers
registry.add_server(MCPServerConfig(name="filesystem", ...))
registry.add_server(MCPServerConfig(name="github", ...))
registry.add_server(MCPServerConfig(name="slack", ...))
registry.add_server(MCPServerConfig(name="database", ...))

# Execute code that orchestrates all of them
await execute_code("""
    # Read config, fetch from GitHub, query DB, notify Slack
    config = await filesystem__read_file({"path": "/config.json"})
    issues = await github__list_issues({"repo": "myorg/myrepo"})
    users = await database__query({"sql": "SELECT * FROM users"})
    await slack__send_message({"channel": "#updates", "text": f"Found {len(issues)} issues"})
""")
```

### 3. Building Reusable Workflows

Save complex multi-tool workflows as skills:

```python
# Save a workflow as a skill
await save_skill({
    "name": "deploy_and_notify",
    "description": "Deploy to production and notify team",
    "code": '''
async def deploy_and_notify(version):
    await github__create_release({"tag": version})
    await kubernetes__deploy({"image": f"myapp:{version}"})
    await slack__send_message({"text": f"Deployed {version} ğŸš€"})
'''
})

# Later, run it
await run_skill({"name": "deploy_and_notify", "arguments": {"version": "1.2.3"}})
```

## See Also

- [MCP Tools](../mcp-tools/index.mdx) - Generating tools from MCP Servers
- [Skills](../skills/index.mdx) - Generating tools from Skills
- [Programmatic Tools](../programmatic-tools/index.mdx) - Executing generated tools
- [Integrations](../integrations/index.mdx) - Using with Pydantic AI
